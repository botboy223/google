<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Key Management System</title>
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>

<h1>Product Key Management System</h1>

<!-- Buttons for interaction -->
<button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
<button id="signout_button" style="display:none;" onclick="handleSignoutClick()">Sign Out</button>

<h2>1. Generate Product Keys</h2>
<label for="num_keys">Number of Product Keys:</label>
<input type="number" id="num_keys" min="1">
<button onclick="generateAndStoreKeys()">Generate & Store Keys</button>

<h2>2. Validate Product Key</h2>
<label for="product_key">Enter Product Key:</label>
<input type="text" id="product_key">
<button onclick="validateProductKey()">Validate Key</button>

<h3 id="message"></h3>

<script>
// Load OAuth client and Google Sheets API
let CLIENT_ID = '436073560587-c1tv96kj6h7agmfujq41gvnavd08s4sh.apps.googleusercontent.com';  // Replace with correct Client ID
let API_KEY = 'AIzaSyBkB-EhLvMkLv05g9T-8_yzjM7GteFEgw8';  // Replace this with your actual Google API key
let SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
let DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

let authorizeButton = document.getElementById('authorize_button');
let signoutButton = document.getElementById('signout_button');

// Spreadsheet details
let spreadsheetId = '1znAiF_PvV9p0aV4cOIk4PmCtgtyNJTmQWwSdoEuWLbg'; // Replace with your actual spreadsheet ID
let sheetName = 'tushae'; // Replace with your actual sheet name

// Initialize the Google API client library
function handleClientLoad() {
    gapi.load('client:auth2', initClient);
}

// Initialize the API client library
function initClient() {
    gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES,
    }).then(() => {
        // Listen for sign-in state changes
        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

        // Handle the initial sign-in state
        updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
    }).catch(error => {
        console.error('Error during initialization', error);
        document.getElementById('message').textContent = 'Error initializing the Google API client.';
    });
}

// Ensure client loads on window load
window.onload = handleClientLoad;

// Update UI based on the signed-in status
function updateSigninStatus(isSignedIn) {
    if (isSignedIn) {
        authorizeButton.style.display = 'none';
        signoutButton.style.display = 'block';
    } else {
        authorizeButton.style.display = 'block';
        signoutButton.style.display = 'none';
    }
}

// Sign in user
function handleAuthClick() {
    gapi.auth2.getAuthInstance().signIn().catch(error => {
        console.error('Error during sign-in', error);
        document.getElementById('message').textContent = 'Error signing in. Please try again.';
    });
}

// Sign out user
function handleSignoutClick() {
    gapi.auth2.getAuthInstance().signOut().catch(error => {
        console.error('Error during sign-out', error);
        document.getElementById('message').textContent = 'Error signing out. Please try again.';
    });
}

// Generate a random product key (format XXXX-XXXX-XXXX-XXXX)
function generateProductKey() {
    let characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let key = '';
    for (let i = 0; i < 16; i++) {
        if (i > 0 && i % 4 === 0) {
            key += '-';
        }
        key += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return key;
}

// Store generated product keys in Google Sheets
function generateAndStoreKeys() {
    let numKeys = document.getElementById('num_keys').value;
    if (!numKeys || numKeys <= 0) {
        document.getElementById('message').textContent = 'Please enter a valid number of keys to generate.';
        return;
    }

    let productKeys = [];
    for (let i = 0; i < numKeys; i++) {
        productKeys.push([generateProductKey(), "unused"]);
    }

    let params = {
        spreadsheetId: spreadsheetId,
        range: `${sheetName}!A1`, // Append new keys starting from A1
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
    };

    let valueRangeBody = {
        "values": productKeys
    };

    gapi.client.sheets.spreadsheets.values.append(params, valueRangeBody).then((response) => {
        document.getElementById('message').textContent = `${numKeys} Product Keys generated and stored successfully.`;
    }).catch(error => {
        console.error('Error storing product keys', error);
        document.getElementById('message').textContent = 'Error generating or storing product keys. Please try again.';
    });
}

// Validate if the product key exists and is unused
function validateProductKey() {
    let productKey = document.getElementById('product_key').value;
    if (!productKey) {
        document.getElementById('message').textContent = 'Please enter a product key to validate.';
        return;
    }

    let params = {
        spreadsheetId: spreadsheetId,
        range: `${sheetName}!A1:B`,
    };

    gapi.client.sheets.spreadsheets.values.get(params).then((response) => {
        let rows = response.result.values;

        if (!rows || rows.length === 0) {
            document.getElementById('message').textContent = 'No product keys found.';
            return;
        }

        // Search for the product key
        let found = false;
        for (let i = 0; i < rows.length; i++) {
            let row = rows[i];
            if (row[0] === productKey && row[1] === 'unused') {
                found = true;

                let username = generateRandomUsername();
                let password = generateRandomPassword();

                // Mark as used and assign username and password
                let updateParams = {
                    spreadsheetId: spreadsheetId,
                    range: `${sheetName}!B${i + 1}:D${i + 1}`,
                    valueInputOption: 'RAW',
                    values: [['used', username, password]],
                };

                gapi.client.sheets.spreadsheets.values.update(updateParams).then(() => {
                    document.getElementById('message').textContent = `Product key valid. Username: ${username}, Password: ${password}`;
                }).catch(error => {
                    console.error('Error updating product key', error);
                    document.getElementById('message').textContent = 'Error updating product key. Please try again.';
                });
                break;
            } else if (row[0] === productKey && row[1] === 'used') {
                document.getElementById('message').textContent = 'Product key has already been used.';
                found = true;
                break;
            }
        }

        if (!found) {
            document.getElementById('message').textContent = 'Invalid product key.';
        }
    }).catch(error => {
        console.error('Error validating product key', error);
        document.getElementById('message').textContent = 'Error validating product key. Please try again.';
    });
}

// Generate random username (8 characters)
function generateRandomUsername() {
    return Math.random().toString(36).substring(2, 10);
}

// Generate random password (10 characters, uppercase and numbers)
function generateRandomPassword() {
    let chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let password = '';
    for (let i = 0; i < 10; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return password;
}

</script>
</body>
</html>
